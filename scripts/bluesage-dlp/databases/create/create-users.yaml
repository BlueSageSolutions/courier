- script: create-users
  sources:
    test-connection-sql:
      data: >
        SELECT 1;
    password-stub:
      data: >
        <REPLACE_PASSWORD>
    create-user-sql:
      data: >
        CREATE USER <BSDLP_CLIENT>_<BSDLP_ENVIRONMENT> IDENTIFIED BY '<REPLACE_PASSWORD>';
    drop-user-sql:
      data: >
        DROP USER <BSDLP_CLIENT>_<BSDLP_ENVIRONMENT>;
    grant-user-privileges-sql:
      data: >
        GRANT ALL PRIVILEGES ON <BSDLP_CLIENT>_<BSDLP_ENVIRONMENT>.* TO <BSDLP_CLIENT>_<BSDLP_ENVIRONMENT>;
    revoke-user-privileges-sql:
      data: >
        REVOKE ALL PRIVILEGES, GRANT OPTION FROM <BSDLP_CLIENT>_<BSDLP_ENVIRONMENT>; FLUSH PRIVILEGES;
    grant-superuser-privileges-sql:
      data: >
        GRANT ALL PRIVILEGES ON <BSDLP_CLIENT>_<BSDLP_ENVIRONMENT>.* TO dlp_fly;
    revoke-superuser-privileges-sql:
      data: >
        REVOKE ALL PRIVILEGES, GRANT OPTION FROM dlp_fly; FLUSH PRIVILEGES;
  setup:
    - command: sts
      sub-command: get-caller-identity
    - description: get the database credentials
      command: ssm
      sensitive: true
      sub-command: get-parameter
      arguments:
        - name: name
          value: "/systems/mysql/lower/defaults-extra-file"
        - name: with-decryption
    - description: grab secret and handle whitespace
      executable: jq
      sensitive: true
      command: .Parameter.Value
      sub-command: -r
      source: create-users:setup:step-1
    - description: create password
      executable: echo
      source: password-stub
      replacements:
        - match: <REPLACE_PASSWORD>
          replace-with-random: 12
    - executable: cat
      command: /tmp/_password-stub.json
    # - description: stash secret in ssm parameter
    #   command: ssm
    #   sensitive: true
    #   sub-command: put-parameter
    #   arguments:
    #     - name: name
    #       value: "/systems/mysql/lower/defaults-extra-file"
    #     - name: type
    #       value: "SecureString"
    #     - name: overwrite
    #     - name: value
    #       source: create-schema:setup:step-7
    #       source-type: text
    - 
  main:
    - description: put credentials in /tmp
      executable: persist-arguments
      sensitive: true
      arguments:
        - name: password
          style: plain
          source: create-users:setup:step-2
          source-type: text
    - description: create user
      executable: mysql
      source: create-user-sql
      replacements:
        - match: <BSDLP_CLIENT>
          replace-with: __CLIENT__
        - match: <BSDLP_ENVIRONMENT>
          replace-with: __ENVIRONMENT__
        - match: <REPLACE_PASSWORD>
          replace-with: create-users:setup:step-4
      arguments:
        - name: use-config
          style: plain
          value: --defaults-extra-file=/tmp/create-users_main_step-0.json
    - description: grant user all privileges
      executable: mysql
      source: grant-user-privileges-sql
      replacements:
        - match: <BSDLP_CLIENT>
          replace-with: __CLIENT__
        - match: <BSDLP_ENVIRONMENT>
          replace-with: __ENVIRONMENT__
      arguments:
        - name: use-config
          style: plain
          value: --defaults-extra-file=/tmp/create-users_main_step-0.json
    - description: grant superuser all privileges
      executable: mysql
      source: grant-superuser-privileges-sql
      replacements:
        - match: <BSDLP_CLIENT>
          replace-with: __CLIENT__
        - match: <BSDLP_ENVIRONMENT>
          replace-with: __ENVIRONMENT__
      arguments:
        - name: use-config
          style: plain
          value: --defaults-extra-file=/tmp/create-users_main_step-0.json
  cleanup:
    - description: drop user
      executable: mysql
      source: drop-user-sql
      replacements:
        - match: <BSDLP_CLIENT>
          replace-with: __CLIENT__
        - match: <BSDLP_ENVIRONMENT>
          replace-with: __ENVIRONMENT__
      arguments:
        - name: use-config
          style: plain
          value: --defaults-extra-file=/tmp/create-users_main_step-0.json
    # - description: revoke from user
    #   executable: mysql
    #   source: revoke-user-privileges-sql
    #   replacements:
    #     - match: <BSDLP_CLIENT>
    #       replace-with: __CLIENT__
    #     - match: <BSDLP_ENVIRONMENT>
    #       replace-with: __ENVIRONMENT__
    #   arguments:
    #     - name: use-config
    #       style: plain
    #       value: --defaults-extra-file=/tmp/create-users_main_step-0.json
    # - description: revoke from superuser all privileges
    #   executable: mysql
    #   source: revoke-superuser-privileges-sql
    #   replacements:
    #     - match: <BSDLP_CLIENT>
    #       replace-with: __CLIENT__
    #     - match: <BSDLP_ENVIRONMENT>
    #       replace-with: __ENVIRONMENT__
    #   arguments:
    #     - name: use-config
    #       style: plain
    #       value: --defaults-extra-file=/tmp/create-users_main_step-0.json

